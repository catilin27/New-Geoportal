<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal de Delitos - Quito</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #34495e;
        }

        .logo h1 {
            color: #3498db;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .logo p {
            color: #bdc3c7;
            font-size: 0.9em;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            background: #34495e;
            padding: 10px 15px;
            margin: -5px -10px 15px -10px;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .section-title:hover {
            background: #4a5f7a;
        }

        .section-title i {
            margin-right: 10px;
        }

        .section-content {
            padding-left: 10px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            transition: background 0.3s;
        }

        .layer-item:hover {
            background: rgba(255,255,255,0.2);
        }

        .layer-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .layer-item label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9em;
        }

        .layer-count {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .basemap-selector {
            margin-bottom: 15px;
        }

        .basemap-selector select {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #34495e;
            color: white;
            font-size: 0.9em;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .tabs {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9em;
            border-radius: 5px 5px 0 0;
            transition: background 0.3s;
        }

        .tab-button:hover {
            background: #2980b9;
        }

        .tab-button.active {
            background: #2c3e50;
        }

        .form-panel {
            position: absolute;
            top: 50px;
            right: 10px;
            width: 300px;
            background: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }

        .form-panel.active {
            display: block;
        }

        .form-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .coordinates-display {
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 3px;
            margin-top: 10px;
            font-size: 0.8em;
            color: #2c3e50;
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 8px;
            border: 1px solid #34495e;
            border-radius: 4px;
            background: #34495e;
            color: white;
            font-size: 0.9em;
        }

        .search-box input::placeholder {
            color: #bdc3c7;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            display: none;
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 50vh;
            }
            
            .map-container {
                height: 50vh;
            }
            
            .container {
                flex-direction: column;
            }
            
            .form-panel {
                width: calc(100% - 20px);
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h1><i class="fas fa-map-marked-alt"></i> GeoPortal</h1>
                <p>Sistema de Monitoreo de Delitos - Quito</p>
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar en el mapa...">
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-map"></i> Mapas Base
                </div>
                <div class="section-content">
                    <div class="basemap-selector">
                        <select id="basemapSelector">
                            <option value="osm">OpenStreetMap</option>
                            <option value="satellite">Satélite</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-layers"></i> Capas Geográficas
                </div>
                <div class="section-content">
                    <div class="layer-item">
                        <input type="checkbox" id="barrios" checked>
                        <label for="barrios">Barrios</label>
                        <span class="layer-count">-</span>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="parroquias" checked>
                        <label for="parroquias">Parroquias</label>
                        <span class="layer-count">-</span>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="adm_zonal">
                        <label for="adm_zonal">Administraciones Zonales</label>
                        <span class="layer-count">-</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-exclamation-triangle"></i> Capas de Delitos
                </div>
                <div class="section-content">
                    <div class="layer-item">
                        <input type="checkbox" id="delitos_generales">
                        <label for="delitos_generales">Delitos Generales</label>
                        <span class="layer-count">-</span>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="delitos_sexuales">
                        <label for="delitos_sexuales">Delitos Sexuales</label>
                        <span class="layer-count">-</span>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="violencia_intrafamiliar">
                        <label for="violencia_intrafamiliar">Violencia Intrafamiliar</label>
                        <span class="layer-count">-</span>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" id="reportes_delitos" checked>
                        <label for="reportes_delitos">Reportes de Delitos</label>
                        <span class="layer-count">-</span>
                    </div>
                </div>
            </div>

            <div class="legend">
                <h4><i class="fas fa-info-circle"></i> Leyenda</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3498db;"></div>
                    <span>Límites Administrativos</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>Delitos Generales</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #9b59b6;"></div>
                    <span>Delitos Sexuales</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f39c12;"></div>
                    <span>Violencia Intrafamiliar</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #27ae60;"></div>
                    <span>Reportes Ciudadanos</span>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('map')">
                    <i class="fas fa-map"></i> Mapa
                </button>
                <button class="tab-button" onclick="showTab('form')">
                    <i class="fas fa-plus"></i> Reportar
                </button>
            </div>

            <div id="map"></div>

            <div class="form-panel" id="formPanel">
                <h3><i class="fas fa-file-alt"></i> Reportar Delito</h3>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="tipoDelito">Tipo de Delito:</label>
                        <select id="tipoDelito" required>
                            <option value="">Seleccione...</option>
                            <option value="robo">Robo</option>
                            <option value="asalto">Asalto</option>
                            <option value="vandalismo">Vandalismo</option>
                            <option value="violencia">Violencia</option>
                            <option value="trafico">Tráfico</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="fecha">Fecha del Incidente:</label>
                        <input type="date" id="fecha" required>
                    </div>

                    <div class="form-group">
                        <label for="hora">Hora del Incidente:</label>
                        <input type="time" id="hora" required>
                    </div>

                    <div class="form-group">
                        <label for="descripcion">Descripción:</label>
                        <textarea id="descripcion" placeholder="Describa el incidente..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="reportante">Nombre del Reportante:</label>
                        <input type="text" id="reportante" placeholder="Nombre completo" required>
                    </div>

                    <div class="form-group">
                        <label for="telefono">Teléfono de Contacto:</label>
                        <input type="tel" id="telefono" placeholder="Número de teléfono">
                    </div>

                    <div class="coordinates-display" id="coordinatesDisplay">
                        <strong>Coordenadas:</strong> Haga clic en el mapa para seleccionar la ubicación
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <button type="button" class="btn" onclick="getCurrentLocation()">
                            <i class="fas fa-map-marker-alt"></i> Usar Mi Ubicación
                        </button>
                        <button type="submit" class="btn btn-success" style="float: right;">
                            <i class="fas fa-paper-plane"></i> Enviar Reporte
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuración del mapa
        const map = L.map('map').setView([-0.1807, -78.4678], 11); // Quito, Ecuador

        // Mapas base
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        });

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri'
        });

        // Añadir mapa base por defecto
        osmLayer.addTo(map);

        // Grupos de capas
        const layerGroups = {
            barrios: L.layerGroup(),
            parroquias: L.layerGroup(),
            adm_zonal: L.layerGroup(),
            delitos_generales: L.layerGroup(),
            delitos_sexuales: L.layerGroup(),
            violencia_intrafamiliar: L.layerGroup(),
            reportes_delitos: L.layerGroup()
        };

        // Añadir capas iniciales al mapa
        layerGroups.barrios.addTo(map);
        layerGroups.parroquias.addTo(map);
        layerGroups.reportes_delitos.addTo(map);

        // Variables para el formulario
        let selectedCoords = null;
        let reportMarker = null;

        // Datos simulados para demostración
        const sampleData = {
            barrios: generateSamplePolygons(50, 'barrio'),
            parroquias: generateSamplePolygons(15, 'parroquia'),
            adm_zonal: generateSamplePolygons(8, 'zona'),
            delitos_generales: generateSamplePolygons(25, 'delito_general'),
            delitos_sexuales: generateSamplePolygons(8, 'delito_sexual'),
            violencia_intrafamiliar: generateSamplePolygons(12, 'violencia'),
            reportes_delitos: generateSamplePoints(30, 'reporte')
        };

        // Función para generar polígonos de muestra
        function generateSamplePolygons(count, type) {
            const polygons = [];
            const colors = {
                'barrio': '#3498db',
                'parroquia': '#2ecc71',
                'zona': '#f39c12',
                'delito_general': '#e74c3c',
                'delito_sexual': '#9b59b6',
                'violencia': '#e67e22'
            };

            for (let i = 0; i < count; i++) {
                const lat = -0.1807 + (Math.random() - 0.5) * 0.5;
                const lng = -78.4678 + (Math.random() - 0.5) * 0.5;
                const size = 0.01 + Math.random() * 0.02;
                
                const polygon = L.polygon([
                    [lat, lng],
                    [lat + size, lng],
                    [lat + size, lng + size],
                    [lat, lng + size]
                ], {
                    color: colors[type],
                    weight: 2,
                    fillOpacity: 0.3
                }).bindPopup(`${type.replace('_', ' ').toUpperCase()} #${i + 1}`);
                
                polygons.push(polygon);
            }
            return polygons;
        }

        // Función para generar puntos de muestra
        function generateSamplePoints(count, type) {
            const points = [];
            const icon = L.divIcon({
                className: 'custom-marker',
                html: '<i class="fas fa-map-marker-alt" style="color: #27ae60; font-size: 20px;"></i>',
                iconSize: [20, 20],
                iconAnchor: [10, 20]
            });

            for (let i = 0; i < count; i++) {
                const lat = -0.1807 + (Math.random() - 0.5) * 0.4;
                const lng = -78.4678 + (Math.random() - 0.5) * 0.4;
                
                const marker = L.marker([lat, lng], { icon })
                    .bindPopup(`Reporte #${i + 1}<br>Tipo: ${['Robo', 'Asalto', 'Vandalismo'][Math.floor(Math.random() * 3)]}<br>Fecha: ${new Date().toLocaleDateString()}`);
                
                points.push(marker);
            }
            return points;
        }

        // Cargar datos simulados en las capas
        Object.keys(sampleData).forEach(layerName => {
            sampleData[layerName].forEach(feature => {
                layerGroups[layerName].addLayer(feature);
            });
            
            // Actualizar contador
            const countElement = document.querySelector(`#${layerName} + label + .layer-count`);
            if (countElement) {
                countElement.textContent = sampleData[layerName].length;
            }
        });

        // Eventos de capas
        document.querySelectorAll('.layer-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const layerName = this.id;
                if (this.checked) {
                    layerGroups[layerName].addTo(map);
                } else {
                    map.removeLayer(layerGroups[layerName]);
                }
            });
        });

        // Cambio de mapa base
        document.getElementById('basemapSelector').addEventListener('change', function() {
            const selectedBasemap = this.value;
            map.eachLayer(layer => {
                if (layer === osmLayer || layer === satelliteLayer) {
                    map.removeLayer(layer);
                }
            });
            
            if (selectedBasemap === 'satellite') {
                satelliteLayer.addTo(map);
            } else {
                osmLayer.addTo(map);
            }
        });

        // Función para mostrar/ocultar tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'form') {
                document.getElementById('formPanel').classList.add('active');
            } else {
                document.getElementById('formPanel').classList.remove('active');
            }
        }

        // Click en el mapa para seleccionar coordenadas
        map.on('click', function(e) {
            if (document.getElementById('formPanel').classList.contains('active')) {
                selectedCoords = e.latlng;
                
                // Remover marcador anterior
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                }
                
                // Añadir nuevo marcador
                const reportIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 25px;"></i>',
                    iconSize: [25, 25],
                    iconAnchor: [12, 25]
                });
                
                reportMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: reportIcon })
                    .addTo(map)
                    .bindPopup('Ubicación del reporte')
                    .openPopup();
                
                // Actualizar display de coordenadas
                document.getElementById('coordinatesDisplay').innerHTML = 
                    `<strong>Coordenadas:</strong> ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
            }
        });

        // Función para obtener ubicación actual
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    selectedCoords = L.latLng(lat, lng);
                    
                    // Remover marcador anterior
                    if (reportMarker) {
                        map.removeLayer(reportMarker);
                    }
                    
                    // Añadir nuevo marcador
                    const reportIcon = L.divIcon({
                        className: 'custom-marker',
                        html: '<i class="fas fa-map-marker-alt" style="color: #e74c3c; font-size: 25px;"></i>',
                        iconSize: [25, 25],
                        iconAnchor: [12, 25]
                    });
                    
                    reportMarker = L.marker([lat, lng], { icon: reportIcon })
                        .addTo(map)
                        .bindPopup('Su ubicación actual')
                        .openPopup();
                    
                    // Centrar mapa en la ubicación
                    map.setView([lat, lng], 15);
                    
                    // Actualizar display de coordenadas
                    document.getElementById('coordinatesDisplay').innerHTML = 
                        `<strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }, function() {
                    showNotification('No se pudo obtener su ubicación', 'error');
                });
            } else {
                showNotification('Geolocalización no soportada', 'error');
            }
        }

        // Envío del formulario
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedCoords) {
                showNotification('Por favor seleccione una ubicación en el mapa', 'error');
                return;
            }
            
            // Simular envío a base de datos
            const formData = {
                tipo: document.getElementById('tipoDelito').value,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                descripcion: document.getElementById('descripcion').value,
                reportante: document.getElementById('reportante').value,
                telefono: document.getElementById('telefono').value,
                lat: selectedCoords.lat,
                lng: selectedCoords.lng
            };
            
            // Simular delay de envío
            setTimeout(() => {
                // Añadir nuevo reporte al mapa
                const newReportIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<i class="fas fa-map-marker-alt" style="color: #27ae60; font-size: 20px;"></i>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 20]
                });
                
                const newReportMarker = L.marker([selectedCoords.lat, selectedCoords.lng], { icon: newReportIcon })
                    .bindPopup(`
                        <strong>Nuevo Reporte</strong><br>
                        Tipo: ${formData.tipo}<br>
                        Fecha: ${formData.fecha}<br>
                        Reportante: ${formData.reportante}
                    `);
                
                layerGroups.reportes_delitos.addLayer(newReportMarker);
                
                // Limpiar formulario
                document.getElementById('reportForm').reset();
                selectedCoords = null;
                if (reportMarker) {
                    map.removeLayer(reportMarker);
                    reportMarker = null;
                }
                document.getElementById('coordinatesDisplay').innerHTML = 
                    '<strong>Coordenadas:</strong> Haga clic en el mapa para seleccionar la ubicación';
                
                // Actualizar contador
                const currentCount = parseInt(document.querySelector('#reportes_delitos + label + .layer-count').textContent);
                document.querySelector('#reportes_delitos + label + .layer-count').textContent = currentCount + 1;
                
                showNotification('Reporte enviado exitosamente', 'success');
                showTab('map');
            }, 1000);
        });

        // Función para mostrar notificaciones
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Establecer fecha actual por defecto
        document.getElementById('fecha').valueAsDate = new Date();

        // Búsqueda simple
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.toLowerCase();
                // Aquí implementarías la lógica de búsqueda
                showNotification(`Buscando: ${searchTerm}`, 'success');
            }
        });
    </script>
</body>
</html>
